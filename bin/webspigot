#!/usr/bin/env ruby
require 'optparse'
require 'webspigot'
require 'pp'

@options = {
  safe_mode: "OFF",
  blur_previous: true,
  blur_amount: '0x6',
  search_phrases: [],
  max_retries: 5,
  outfile: '/tmp/spigot-composite.png'
}

@optparser = OptionParser.new do |o|
  o.banner = "Usage: webspigot"
  o.parse!
end

def usage
  puts @optparser
  exit
end

def get_loc(w, h)
  x = (w * rand).to_i - 400
  y = (h * rand).to_i - 400
  [x, y]
end

unless ARGV[0].nil?
  @options[:search_phrases] = ARGV[0].split(';')
end

ws = Webspigot.new(@options)
while true
  ws.run
  image_path = ws.save
  #puts "Search: #{ws.search_phrase}"
  #puts "Image : #{ws.image_url}"
  #puts "Saved : #{image_path}"
  w = 1920
  h = 1080
  loc = get_loc(w, h)

  # blur the composite
  if @options[:blur_previous]
    `convert #{@options[:outfile]} -blur #{@options[:blur_amount]} #{@options[:outfile]}`
  end
  # add the search phrase
  `convert #{image_path} -background black -fill white label:'          #{ws.search_phrase}' -append #{image_path}`
  # blur edges of current image
  `convert #{image_path} -alpha set -virtual-pixel transparent -channel A -blur 0x8 -level 50%,100% +channel #{image_path}.png`
  # compose blurred composite and current image
  `convert -background black -page #{w}x#{h} #{@options[:outfile]} -page +#{loc[0]}+#{loc[1]} #{image_path}.png -flatten #{@options[:outfile]}`

  #`feh --bg-fill #{@outfile}`
  #puts "cleaning up"
  File.delete(image_path)
  File.delete("#{image_path}.png")
  sleep 10
end
